<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>schlagzeugleihen.de ‚Äì Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e1117;
    --bg-card: #161b22;
    --bg-card-hover: #1c2333;
    --border: #21262d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #f0883e;
    --accent-glow: rgba(240, 136, 62, 0.15);
    --green: #3fb950;
    --green-bg: rgba(63, 185, 80, 0.1);
    --red: #f85149;
    --red-bg: rgba(248, 81, 73, 0.1);
    --yellow: #d29922;
    --yellow-bg: rgba(210, 153, 34, 0.1);
    --blue: #58a6ff;
    --blue-bg: rgba(88, 166, 255, 0.1);
    --purple: #bc8cff;
    --purple-bg: rgba(188, 140, 255, 0.1);
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* ===== PIN SCREEN ===== */
  #pin-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    animation: fadeIn 0.4s ease;
  }

  #pin-screen .logo {
    font-family: 'Space Mono', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.5px;
    margin-bottom: 8px;
  }

  #pin-screen .subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 32px;
  }

  #pin-input {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    padding: 14px 20px;
    border-radius: var(--radius);
    width: 280px;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
  }

  #pin-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  #pin-input.error {
    border-color: var(--red);
    animation: shake 0.4s ease;
  }

  #pin-btn {
    margin-top: 16px;
    background: var(--accent);
    color: #fff;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    padding: 12px 32px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: opacity 0.2s;
    width: 280px;
  }

  #pin-btn:hover { opacity: 0.85; }

  /* ===== DASHBOARD ===== */
  #dashboard {
    display: none;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .header-left .logo {
    font-family: 'Space Mono', monospace;
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .header-left .page-title {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .header-right { text-align: right; }

  /* ===== TABS ===== */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px;
  }

  .tab {
    flex: 1;
    padding: 10px 16px;
    border: none;
    background: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    position: relative;
  }

  .tab:hover { color: var(--text); }

  .tab.active {
    background: var(--accent);
    color: #fff;
  }

  .tab .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 6px;
  }

  .tab.active .badge {
    background: rgba(255,255,255,0.25);
    color: #fff;
  }

  .tab:not(.active) .badge {
    background: var(--accent-glow);
    color: var(--accent);
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ===== STAT CARDS ===== */
  .stat-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    flex: 1;
    min-width: 140px;
  }

  .stat-card .label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .stat-card .value {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
  }

  .stat-card .value.green { color: var(--green); }
  .stat-card .value.accent { color: var(--accent); }
  .stat-card .value.blue { color: var(--blue); }
  .stat-card .value.red { color: var(--red); }

  /* ===== SECTION TITLE ===== */
  .section-title {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  /* ===== MIET CARDS ===== */
  .miet-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
    transition: background 0.15s, border-color 0.15s;
  }

  .miet-card:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent);
  }

  .miet-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 14px;
  }

  .miet-kunde { font-size: 1.05rem; font-weight: 600; }

  .miet-instrument {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .miet-status {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .status-aktiv { background: var(--green-bg); color: var(--green); }
  .status-warnung { background: var(--yellow-bg); color: var(--yellow); }
  .status-ueberfaellig { background: var(--red-bg); color: var(--red); }
  .status-offen { background: var(--blue-bg); color: var(--blue); }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
  }

  .detail-item { display: flex; flex-direction: column; }

  .detail-item .dl {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .detail-item .dv {
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 2px;
  }

  .detail-item .dv.mono {
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem;
  }

  .miet-bar-container {
    margin-top: 14px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    height: 6px;
    overflow: hidden;
  }

  .miet-bar {
    height: 100%;
    border-radius: 6px;
    transition: width 0.6s ease;
  }

  .miet-bar.green { background: var(--green); }
  .miet-bar.yellow { background: var(--yellow); }
  .miet-bar.red { background: var(--red); }

  .miet-bar-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 4px;
    text-align: right;
  }

  .kaution-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
  }

  .kaution-ja { background: var(--green-bg); color: var(--green); }
  .kaution-nein { background: var(--red-bg); color: var(--red); }

  /* ===== ANFRAGE GROUPS ===== */
  .anfrage-group {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 16px;
    overflow: hidden;
  }

  .anfrage-group-header {
    background: var(--bg-card);
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .anfrage-group-kunde {
    font-size: 1.1rem;
    font-weight: 700;
  }

  .anfrage-group-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .anfrage-group-meta span { display: inline-flex; align-items: center; gap: 4px; }

  .beratung-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 12px;
    background: var(--purple-bg);
    color: var(--purple);
  }

  .entfernung-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 12px;
    background: var(--yellow-bg);
    color: var(--yellow);
  }

  .anfrage-text-box {
    background: rgba(88, 166, 255, 0.06);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    font-size: 0.85rem;
    line-height: 1.5;
    color: var(--text);
  }

  .anfrage-text-label {
    font-weight: 600;
    color: var(--blue);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .anfrage-option {
    background: var(--bg-card);
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  .anfrage-option:hover { background: var(--bg-card-hover); }

  .anfrage-option-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .anfrage-option-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
  }

  .anfrage-option-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 10px;
    border-radius: 20px;
    background: var(--blue-bg);
    color: var(--blue);
    white-space: nowrap;
  }

  .anfrage-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .anfrage-actions-group {
    padding: 12px 20px;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .anfrage-grund-wrapper {
    flex: 1;
    min-width: 200px;
  }

  .anfrage-grund-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 4px;
  }

  .anfrage-grund-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    padding: 8px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s;
  }

  .anfrage-grund-input:focus {
    border-color: var(--accent);
  }

  .anfrage-grund-input::placeholder {
    color: var(--text-muted);
    opacity: 0.6;
  }

  .btn-senden, .btn-ablehnen, .btn-angenommen {
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
  }

  .btn-senden {
    background: var(--green);
    color: #fff;
  }

  .btn-ablehnen {
    background: var(--red);
    color: #fff;
  }

  .btn-angenommen {
    background: var(--accent);
    color: #fff;
  }

  .btn-senden:hover, .btn-ablehnen:hover, .btn-angenommen:hover { opacity: 0.8; }

  .btn-senden:disabled, .btn-ablehnen:disabled, .btn-angenommen:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .anfrage-status-badge {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 8px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .status-versendet { background: var(--accent-glow); color: var(--accent); }
  .status-offen { background: var(--blue-bg); color: var(--blue); }

  /* ===== LOADING & UTILITY ===== */
  .loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  .refresh-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.75rem;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .last-update {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 24px;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 500;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 90vw;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .toast.success { border-color: var(--green); }
  .toast.error { border-color: var(--red); }
  .toast.warning { border-color: var(--yellow); }

  /* ===== ALERT BANNER ===== */
  .alert-banner {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--red-bg);
    border: 1px solid rgba(248, 81, 73, 0.3);
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }

  .alert-banner:hover {
    background: rgba(248, 81, 73, 0.15);
    border-color: var(--red);
  }

  .alert-banner.warning {
    background: var(--yellow-bg);
    border-color: rgba(210, 153, 34, 0.3);
  }

  .alert-banner.warning:hover {
    background: rgba(210, 153, 34, 0.15);
    border-color: var(--yellow);
  }

  .alert-icon { font-size: 1.1rem; }
  .alert-text { flex: 1; font-size: 0.85rem; font-weight: 500; }
  .alert-arrow { color: var(--text-muted); font-size: 0.85rem; }

  /* ===== AUFGABEN KARTEN ===== */
  .aufgabe-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
    transition: background 0.15s, border-color 0.15s;
  }

  .aufgabe-card:hover {
    background: var(--bg-card-hover);
  }

  .aufgabe-card.priority-high {
    border-left: 3px solid var(--red);
  }

  .aufgabe-card.priority-medium {
    border-left: 3px solid var(--yellow);
  }

  .aufgabe-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .aufgabe-type {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .type-bestellen { background: var(--red-bg); color: var(--red); }
  .type-bereit { background: var(--green-bg); color: var(--green); }

  .aufgabe-title {
    font-size: 1.05rem;
    font-weight: 600;
  }

  .aufgabe-subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .aufgabe-actions {
    display: flex;
    gap: 8px;
    margin-top: 14px;
    flex-wrap: wrap;
  }

  .btn-zuweisen {
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
    background: var(--green);
    color: #fff;
  }

  .btn-zuweisen:hover { opacity: 0.8; }
  .btn-zuweisen:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-bestellt {
    border: 1px solid var(--border);
    background: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    color: var(--text-muted);
  }

  .btn-bestellt:hover { border-color: var(--accent); color: var(--accent); }
  .btn-bestellt:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ===== ANIMATIONS ===== */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 600px) {
    #dashboard { padding: 16px; }
    .stat-row { gap: 8px; }
    .stat-card { padding: 12px 14px; min-width: 100px; }
    .stat-card .value { font-size: 1.2rem; }
    .miet-card, .anfrage-option { padding: 14px; }
    .detail-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    .anfrage-actions, .anfrage-actions-group { flex-direction: column; }
    .anfrage-grund-wrapper { min-width: 100%; }
    .anfrage-group-meta { gap: 6px; font-size: 0.75rem; }
  }
</style>
</head>
<body>

<!-- PIN SCREEN -->
<div id="pin-screen">
  <div class="logo">schlagzeugleihen.de</div>
  <div class="subtitle">Dashboard Login</div>
  <input type="password" id="pin-input" placeholder="PIN eingeben" autocomplete="off">
  <button id="pin-btn" onclick="checkPin()">Anmelden</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="header">
    <div class="header-left">
      <div class="logo">schlagzeugleihen.de</div>
      <div class="page-title">Dashboard</div>
    </div>
    <div class="header-right">
      <button class="refresh-btn" onclick="refreshAll()">‚Üª Aktualisieren</button>
      <div class="last-update" id="last-update"></div>
    </div>
  </div>

  <!-- ALERT BANNER -->
  <div class="alert-banner" id="alert-banner" style="display:none;" onclick="switchTab('aufgaben')">
    <span class="alert-icon">‚ö†</span>
    <span class="alert-text" id="alert-text"></span>
    <span class="alert-arrow">‚Üí</span>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="mieten" onclick="switchTab('mieten')">
      Aktive Mieten <span class="badge" id="badge-mieten">‚Äì</span>
    </button>
    <button class="tab" data-tab="anfragen" onclick="switchTab('anfragen')">
      Anfragen <span class="badge" id="badge-anfragen">‚Äì</span>
    </button>
    <button class="tab" data-tab="aufgaben" onclick="switchTab('aufgaben')">
      Aufgaben <span class="badge" id="badge-aufgaben" style="display:none;">0</span>
    </button>
  </div>

  <!-- TAB: AKTIVE MIETEN -->
  <div class="tab-content active" id="tab-mieten">
    <div class="stat-row" id="stats">
      <div class="stat-card">
        <div class="label">Aktive Mieten</div>
        <div class="value green" id="stat-count">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="label">Monatl. Einnahmen</div>
        <div class="value accent" id="stat-revenue">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="label">N√§chstes Ende</div>
        <div class="value blue" id="stat-next-end">‚Äì</div>
      </div>
    </div>

    <div class="section-title">Aktive Mietvertr√§ge</div>
    <div id="miet-list">
      <div class="loading">
        <div class="loading-spinner"></div>
        Daten werden geladen...
      </div>
    </div>
  </div>

  <!-- TAB: ANFRAGEN -->
  <div class="tab-content" id="tab-anfragen">
    <div class="stat-row">
      <div class="stat-card">
        <div class="label">Neue Anfragen</div>
        <div class="value blue" id="stat-anfragen">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="label">Versendet (warten)</div>
        <div class="value accent" id="stat-versendet">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="label">Potenzielle Einnahmen</div>
        <div class="value green" id="stat-anfragen-revenue">‚Äì</div>
      </div>
    </div>

    <div class="section-title">Offene Anfragen</div>
    <div id="anfragen-list">
      <div class="loading">
        <div class="loading-spinner"></div>
        Daten werden geladen...
      </div>
    </div>
  </div>

  <!-- TAB: AUFGABEN -->
  <div class="tab-content" id="tab-aufgaben">
    <div class="stat-row">
      <div class="stat-card">
        <div class="label">Zu bestellen</div>
        <div class="value red" id="stat-bestellen">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="label">Bereit zur √úbergabe</div>
        <div class="value green" id="stat-bereit">‚Äì</div>
      </div>
    </div>

    <div class="section-title">Offene Aufgaben</div>
    <div id="aufgaben-list">
      <div class="loading">
        <div class="loading-spinner"></div>
        Daten werden geladen...
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
  // ===== CONFIG =====
  const BASEROW_URL = 'https://baserow.mb-smartsystems.de';
  const BASEROW_TOKEN = 'REDACTED_TOKEN';
  const PIN = 'REDACTED_PIN';
  const N8N_BASE_URL = 'https://n8n.mb-smartsystems.de/webhook';
  const HOME_PLZ = '64665';

  // ===== XSS HELPER =====
  function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ===== PIN =====
  document.getElementById('pin-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') checkPin();
    document.getElementById('pin-input').classList.remove('error');
  });

  function checkPin() {
    const input = document.getElementById('pin-input');
    if (input.value === PIN) {
      document.getElementById('pin-screen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      refreshAll();
    } else {
      input.classList.add('error');
      input.value = '';
      input.placeholder = 'Falscher PIN';
      setTimeout(() => { input.placeholder = 'PIN eingeben'; }, 1500);
    }
  }

  // ===== TABS =====
  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
  }

  // ===== TOAST =====
  function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
  }

  // ===== DATA HELPERS =====
  async function fetchRows(tableId) {
    const url = `${BASEROW_URL}/api/database/rows/table/${tableId}/?user_field_names=true&size=200`;
    const res = await fetch(url, {
      headers: { 'Authorization': `Token ${BASEROW_TOKEN}` }
    });
    if (!res.ok) throw new Error(`Baserow error ${res.status}`);
    const data = await res.json();
    return data.results;
  }

  function formatDate(iso) {
    if (!iso) return '‚Äì';
    const d = new Date(iso);
    return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  function formatEuro(val) {
    const n = parseFloat(val) || 0;
    return n.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
  }

  function daysUntil(iso) {
    if (!iso) return Infinity;
    return Math.ceil((new Date(iso) - new Date()) / (1000 * 60 * 60 * 24));
  }

  function progressPercent(start, end) {
    if (!start || !end) return 0;
    const s = new Date(start).getTime();
    const e = new Date(end).getTime();
    const now = Date.now();
    if (now >= e) return 100;
    if (now <= s) return 0;
    return Math.round(((now - s) / (e - s)) * 100);
  }

  function plzEntfernung(plz1, plz2) {
    if (!plz1 || !plz2) return 0;
    return Math.abs(parseInt(plz1) - parseInt(plz2));
  }

  // ===== REFRESH ALL =====
  async function refreshAll() {
    await Promise.all([loadMieten(), loadAnfragen(), loadAufgaben()]);
    document.getElementById('last-update').textContent =
      'Aktualisiert: ' + new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // ===== LOAD AUFGABEN =====
  async function loadAufgaben() {
    const listEl = document.getElementById('aufgaben-list');
    listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Daten werden geladen...</div>';

    try {
      const [mieten, kunden, instrumente, preismodelle] = await Promise.all([
        fetchRows(785), fetchRows(784), fetchRows(783), fetchRows(786)
      ]);

      const kundenMap = {};
      kunden.forEach(k => { kundenMap[k.id] = k; });

      const instrumenteMap = {};
      instrumente.forEach(i => { instrumenteMap[i.id] = i; });

      const preismodellMap = {};
      preismodelle.forEach(p => { preismodellMap[p.id] = p; });

      // Mieten mit Status Bestellt oder Bereit
      const aufgaben = mieten.filter(m =>
        m.Status && ['Bestellt', 'Bereit'].includes(m.Status.value)
      );

      // Z√§hle nach Typ
      const anzBestellen = aufgaben.filter(a => a.Status.value === 'Bestellt').length;
      const anzBereit = aufgaben.filter(a => a.Status.value === 'Bereit').length;
      const totalAufgaben = aufgaben.length;

      document.getElementById('stat-bestellen').textContent = anzBestellen;
      document.getElementById('stat-bereit').textContent = anzBereit;

      // Badge
      const badgeEl = document.getElementById('badge-aufgaben');
      if (totalAufgaben > 0) {
        badgeEl.textContent = totalAufgaben;
        badgeEl.style.display = '';
      } else {
        badgeEl.style.display = 'none';
      }

      // Alert Banner
      const bannerEl = document.getElementById('alert-banner');
      const bannerTextEl = document.getElementById('alert-text');
      if (anzBestellen > 0) {
        const plural = anzBestellen === 1 ? 'Instrument muss' : 'Instrumente m√ºssen';
        bannerTextEl.textContent = `${anzBestellen} ${plural} bestellt werden`;
        bannerEl.className = 'alert-banner';
        bannerEl.style.display = 'flex';
      } else if (anzBereit > 0) {
        const plural = anzBereit === 1 ? 'Instrument ist' : 'Instrumente sind';
        bannerTextEl.textContent = `${anzBereit} ${plural} bereit zur √úbergabe`;
        bannerEl.className = 'alert-banner warning';
        bannerEl.style.display = 'flex';
      } else {
        bannerEl.style.display = 'none';
      }

      // Lagernde Instrumente f√ºr Zuweisungs-Optionen
      const lagernde = instrumente.filter(i =>
        i.Verf√ºgbar?.value === 'Lagernd' &&
        i.Zustand?.value !== 'Defekt' &&
        i.Zustand?.value !== 'Ausgemustert / inaktiv'
      );

      if (totalAufgaben === 0) {
        listEl.innerHTML = '<div class="loading">Keine offenen Aufgaben ‚Äì alles erledigt ‚úì</div>';
        return;
      }

      // Sortiere: Bestellt zuerst, dann Bereit
      aufgaben.sort((a, b) => {
        const order = { 'Bestellt': 0, 'Bereit': 1 };
        return (order[a.Status.value] || 99) - (order[b.Status.value] || 99);
      });

      listEl.innerHTML = '';

      aufgaben.forEach(m => {
        const kundeId = m.Kunde_ID?.[0]?.id;
        const kunde = kundenMap[kundeId] || {};
        const kundeName = [kunde.Vorname, kunde.Nachname].filter(Boolean).join(' ') || 'Unbekannt';
        const istBestellt = m.Status.value === 'Bestellt';

        // Produkte aus Notizen extrahieren
        const notizen = m.Notizen || '';
        const produkteMatch = notizen.match(/Produkte:\s*(.+)/);
        const produkte = produkteMatch ? produkteMatch[1].trim() : '‚Äì';

        // Angebots-Infos
        const angebotId = m.Angebot_ID?.[0]?.id;

        // Finde passendes lagerndes Instrument (√ºber Preismodell-Match oder Modellname)
        let matchendeInstrumente = [];
        if (istBestellt) {
          // Versuche Produkt-Name-basiertes Matching
          const produktLower = produkte.toLowerCase();
          matchendeInstrumente = lagernde.filter(instr => {
            const modell = (instr.Modellname || '').toLowerCase();
            // Pr√ºfe ob eines der Produkte zum Instrument passt
            return modell && produktLower.includes(modell);
          });
        }

        const card = document.createElement('div');
        card.className = `aufgabe-card ${istBestellt ? 'priority-high' : 'priority-medium'}`;

        let actionsHTML = '';
        if (istBestellt) {
          if (matchendeInstrumente.length > 0) {
            const optionsHTML = matchendeInstrumente.map(i =>
              `<option value="${i.id}">${esc(i.Modellname)} (${esc(i.Zustand?.value || '?')})</option>`
            ).join('');
            actionsHTML = `
              <select class="btn-bestellt" id="select-instr-${m.id}" style="padding:7px 12px;">
                ${optionsHTML}
              </select>
              <button class="btn-zuweisen" onclick="instrumentZuweisen(${m.id}, 'select-instr-${m.id}', '${kundeName.replace(/'/g, "\\'")}', 'Bereit')">üì¶ Instrument zuweisen ‚Üí Bereit</button>
            `;
          } else {
            actionsHTML = `
              <span style="font-size:0.8rem;color:var(--text-muted);">Kein passendes Instrument lagernd ‚Äì zuerst in Baserow anlegen</span>
            `;
          }
        } else {
          // Status Bereit ‚Üí Aktivieren
          actionsHTML = `
            <button class="btn-zuweisen" onclick="mietAktivieren(${m.id}, '${kundeName.replace(/'/g, "\\'")}')">üöÄ Miete aktivieren</button>
          `;
        }

        card.innerHTML = `
          <div class="aufgabe-card-header">
            <div>
              <div class="aufgabe-title">${esc(kundeName)} <span style="color:var(--text-muted);font-size:0.8rem;font-weight:400;">¬∑ Miet-ID ${m.Miet_ID || m.id}</span></div>
              <div class="aufgabe-subtitle">${esc(produkte)}</div>
            </div>
            <span class="aufgabe-type ${istBestellt ? 'type-bestellen' : 'type-bereit'}">
              ${istBestellt ? 'üî¥ Bestellen' : 'üü¢ Bereit'}
            </span>
          </div>
          <div class="aufgabe-actions">
            ${actionsHTML}
          </div>
        `;
        listEl.appendChild(card);
      });

    } catch (err) {
      listEl.innerHTML = `<div class="loading" style="color: var(--red);">Fehler: ${err.message}</div>`;
    }
  }

  // ===== INSTRUMENT ZUWEISEN =====
  async function instrumentZuweisen(mietId, selectElId, kundeName, zielStatus) {
    const selectEl = document.getElementById(selectElId);
    const instrumentId = parseInt(selectEl.value);

    if (!confirm(`Instrument dem Mietvertrag f√ºr "${kundeName}" zuweisen?\nStatus wird auf "${zielStatus}" gesetzt.`)) return;

    try {
      // Miete updaten: Instrument zuweisen + Status
      const mietUpdate = {
        Instrument_ID: [instrumentId],
        Status: zielStatus
      };

      await fetch(`${BASEROW_URL}/api/database/rows/table/785/${mietId}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(mietUpdate)
      });

      // Instrument ‚Üí Vermietet
      await fetch(`${BASEROW_URL}/api/database/rows/table/783/${instrumentId}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ Verf√ºgbar: 'Vermietet' })
      });

      showToast(`‚úì Instrument zugewiesen ‚Üí ${zielStatus}`, 'success');
      setTimeout(() => refreshAll(), 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
    }
  }

  // ===== MIET STATUS √ÑNDERN =====
  async function mietStatusAendern(mietId, neuerStatus, kundeName) {
    try {
      await fetch(`${BASEROW_URL}/api/database/rows/table/785/${mietId}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ Status: neuerStatus })
      });

      showToast(`‚úì Miete f√ºr ${kundeName} ‚Üí ${neuerStatus}`, 'success');
      setTimeout(() => refreshAll(), 1000);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
    }
  }

  // ===== MIETE AKTIVIEREN =====
  async function mietAktivieren(mietId, kundeName) {
    if (!confirm(`Miete f√ºr "${kundeName}" aktivieren? Mietbeginn wird auf heute gesetzt.`)) return;

    try {
      await fetch(`${BASEROW_URL}/api/database/rows/table/785/${mietId}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          Status: 'Aktiv',
          Mietbeginn: new Date().toISOString().split('T')[0]
        })
      });

      showToast(`‚úì Miete f√ºr ${kundeName} aktiviert!`, 'success');
      setTimeout(() => refreshAll(), 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
    }
  }

  // ===== LOAD MIETEN =====
  async function loadMieten() {
    const listEl = document.getElementById('miet-list');
    listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Daten werden geladen...</div>';

    try {
      const [mieten, kunden, instrumente] = await Promise.all([
        fetchRows(785), fetchRows(784), fetchRows(783)
      ]);

      const kundenMap = {};
      kunden.forEach(k => { kundenMap[k.id] = k; });
      const instrumenteMap = {};
      instrumente.forEach(i => { instrumenteMap[i.id] = i; });

      const aktiv = mieten.filter(m =>
        m.Status && ['Aktiv', 'Verl√§ngert', 'unbefristet'].includes(m.Status.value)
      );

      aktiv.sort((a, b) => {
        const da = a.Mietende_berechnet || '9999-12-31';
        const db = b.Mietende_berechnet || '9999-12-31';
        return da.localeCompare(db);
      });

      const totalRevenue = aktiv.reduce((sum, m) => sum + (parseFloat(m.Preis_monat_EUR) || 0), 0);
      const nextEnd = aktiv.map(m => m.Mietende_berechnet).filter(Boolean).sort()[0];

      document.getElementById('stat-count').textContent = aktiv.length;
      document.getElementById('stat-revenue').textContent = formatEuro(totalRevenue);
      document.getElementById('stat-next-end').textContent = nextEnd ? formatDate(nextEnd) : '‚Äì';
      document.getElementById('badge-mieten').textContent = aktiv.length;

      if (aktiv.length === 0) {
        listEl.innerHTML = '<div class="loading">Keine aktiven Mieten gefunden.</div>';
        return;
      }

      listEl.innerHTML = '';

      aktiv.forEach(m => {
        const kunde = kundenMap[m.Kunde_ID?.[0]?.id] || {};
        const instrument = instrumenteMap[m.Instrument_ID?.[0]?.id] || {};
        const kundeName = esc([kunde.Vorname, kunde.Nachname].filter(Boolean).join(' ') || 'Unbekannt');
        const instrName = esc(instrument.Modellname || 'Unbekannt');
        const instrTyp = esc(instrument.Typ || '');

        const mietende = m.Mietende_berechnet;
        const days = daysUntil(mietende);
        const pct = progressPercent(m.Mietbeginn, mietende);

        let statusClass = 'status-aktiv', statusText = 'Aktiv';
        if (days <= 0) { statusClass = 'status-ueberfaellig'; statusText = '√úberf√§llig'; }
        else if (days <= 30) { statusClass = 'status-warnung'; statusText = `${days} Tage`; }

        const kautionGezahlt = m.Kaution_gezahlt?.value === 'Ja';
        let barClass = 'green';
        if (pct > 85) barClass = 'red';
        else if (pct > 65) barClass = 'yellow';

        const card = document.createElement('div');
        card.className = 'miet-card';
        card.innerHTML = `
          <div class="miet-card-top">
            <div>
              <div class="miet-kunde">${kundeName}</div>
              <div class="miet-instrument">${instrName} ¬∑ ${instrTyp}</div>
            </div>
            <span class="miet-status ${statusClass}">${statusText}</span>
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="dl">Mietbeginn</span>
              <span class="dv">${formatDate(m.Mietbeginn)}</span>
            </div>
            <div class="detail-item">
              <span class="dl">Mietende</span>
              <span class="dv">${formatDate(mietende)}</span>
            </div>
            <div class="detail-item">
              <span class="dl">Monatspreis</span>
              <span class="dv mono">${formatEuro(m.Preis_monat_EUR)}</span>
            </div>
            <div class="detail-item">
              <span class="dl">Kaution</span>
              <span class="dv">
                <span class="kaution-badge ${kautionGezahlt ? 'kaution-ja' : 'kaution-nein'}">
                  ${kautionGezahlt ? '‚úì' : '‚úó'} ${formatEuro(m.Kaution_EUR)}
                </span>
              </span>
            </div>
            <div class="detail-item">
              <span class="dl">Zahlungsart</span>
              <span class="dv">${esc(m.Zahlungsart?.value || '‚Äì')}</span>
            </div>
            <div class="detail-item">
              <span class="dl">Laufzeit</span>
              <span class="dv">${m.Laufzeit_Monate || '‚Äì'} Monate</span>
            </div>
          </div>
          <div class="miet-bar-container">
            <div class="miet-bar ${barClass}" style="width: ${pct}%"></div>
          </div>
          <div class="miet-bar-label">${pct}% der Mindestlaufzeit</div>
        `;
        listEl.appendChild(card);
      });

    } catch (err) {
      listEl.innerHTML = `<div class="loading" style="color: var(--red);">Fehler: ${err.message}</div>`;
    }
  }

  // ===== LOAD ANFRAGEN (mit Multi-Set-Gruppierung) =====
  async function loadAnfragen() {
    const listEl = document.getElementById('anfragen-list');
    listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Daten werden geladen...</div>';

    try {
      const [angebote, kunden] = await Promise.all([
        fetchRows(787), fetchRows(784)
      ]);

      const kundenMap = {};
      kunden.forEach(k => { kundenMap[k.id] = k; });

      const offene = angebote.filter(a => ['offen', 'versendet'].includes(a.Status?.value));

      // Gruppiere Angebote vom gleichen Kunden + gleichem Datum (= eine Anfrage mit mehreren Sets)
      const groups = {};
      offene.forEach(a => {
        const kundeId = a.Kunden_ID?.[0]?.id || 'unknown';
        const datum = a.Angebotsdatum || '';
        const key = `${kundeId}_${datum}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(a);
      });

      // Sortiere: neueste Anfragen zuerst
      const sortedKeys = Object.keys(groups).sort((a, b) => {
        const dA = groups[a][0]?.Angebotsdatum || '0000';
        const dB = groups[b][0]?.Angebotsdatum || '0000';
        return dB.localeCompare(dA);
      });

      // Stats
      const anzOffen = offene.filter(a => a.Status?.value === 'offen').length;
      const anzVersendet = offene.filter(a => a.Status?.value === 'versendet').length;
      const potRevenue = offene.reduce((sum, a) => sum + (parseFloat(a.Preis_monat_EUR) || 0), 0);
      document.getElementById('stat-anfragen').textContent = anzOffen;
      document.getElementById('stat-versendet').textContent = anzVersendet;
      document.getElementById('stat-anfragen-revenue').textContent = formatEuro(potRevenue) + '/Mo';
      document.getElementById('badge-anfragen').textContent = sortedKeys.length;

      if (sortedKeys.length === 0) {
        listEl.innerHTML = '<div class="loading">Keine offenen Anfragen.</div>';
        return;
      }

      listEl.innerHTML = '';

      sortedKeys.forEach(key => {
        const angeboteInGroup = groups[key];
        const first = angeboteInGroup[0];
        const kundeId = first.Kunden_ID?.[0]?.id;
        const kunde = kundenMap[kundeId] || {};

        const kundeName = esc([kunde.Vorname, kunde.Nachname].filter(Boolean).join(' ') || 'Unbekannt');
        const kundeEmail = esc(kunde.EMail || '');
        const kundeTelefon = esc(kunde.Telefon || '');
        const kundeStrasse = esc(kunde.Adresse_Strasse || '');
        const kundePLZ = esc(kunde.Adresse_PLZ || '');
        const kundeOrt = esc(kunde.Adresse_Ort || '');
        const anfrageText = esc(first.Anfragetext || '');

        const entfernungDiff = plzEntfernung(HOME_PLZ, kunde.Adresse_PLZ);
        const istWeit = entfernungDiff > 5;

        // Pr√ºfe ob Beratung gew√ºnscht (in Produkte-Text enthalten)
        const hatBeratung = angeboteInGroup.some(a =>
          (a.Produkte || '').toLowerCase().includes('beratung')
        );

        const isMulti = angeboteInGroup.length > 1;

        // Adresse formatieren
        const adresseTeile = [kundeStrasse, [kundePLZ, kundeOrt].filter(Boolean).join(' ')].filter(Boolean);
        const adresse = adresseTeile.join(', ') || '‚Äì';

        // Baue Gruppen-Container
        const group = document.createElement('div');
        group.className = 'anfrage-group';

        // === Header mit Kundendaten ===
        let headerHTML = `
          <div class="anfrage-group-header">
            <div class="anfrage-group-kunde">${kundeName}</div>
            <div class="anfrage-group-meta">
              <span>üìß ${kundeEmail || '‚Äì'}</span>
              <span>üì± ${kundeTelefon || '‚Äì'}</span>
              <span>üìç ${adresse}</span>
              <span>üìÖ Anfrage: ${formatDate(first.Angebotsdatum)}</span>
              <span>‚è≥ G√ºltig bis: ${formatDate(first.Gueltig_bis)}</span>
              ${isMulti ? `<span class="anfrage-option-label">${angeboteInGroup.length} Optionen</span>` : ''}
              ${hatBeratung ? '<span class="beratung-badge">üí° Beratung gew√ºnscht</span>' : ''}
              ${istWeit ? `<span class="entfernung-badge">‚ö† PLZ ${kundePLZ} ‚Äì evtl. weite Entfernung</span>` : ''}
            </div>
          </div>
        `;

        // === Anliegen Box ===
        let anliegenHTML = '';
        if (anfrageText) {
          anliegenHTML = `
            <div class="anfrage-text-box">
              <span class="anfrage-text-label">üí¨ Anliegen:</span> ${anfrageText}
            </div>
          `;
        }

        // === Angebots-Optionen ===
        let optionsHTML = '';
        angeboteInGroup.forEach((a, idx) => {
          const optionLabel = isMulti ? `Option ${idx + 1}` : 'Angebot';
          const safeKundeName = kundeName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const istVersendet = a.Status?.value === 'versendet';

          let buttonsHTML = '';
          if (istVersendet) {
            buttonsHTML = `
              <button class="btn-angenommen" id="btn-angenommen-${a.id}" onclick="angebotAngenommen(${a.id}, '${safeKundeName}')">‚úì Angebot angenommen</button>
              <button class="btn-ablehnen" id="btn-ablehnen-${a.id}" onclick="angebotAblehnen(${a.id}, '${safeKundeName}')">‚úó Ablehnen</button>
            `;
          } else {
            buttonsHTML = `
              <button class="btn-senden" id="btn-senden-${a.id}" onclick="angebotSenden(${a.id}, '${safeKundeName}')">‚úâ Angebot senden</button>
              <button class="btn-ablehnen" id="btn-ablehnen-${a.id}" onclick="angebotAblehnen(${a.id}, '${safeKundeName}')">‚úó Ablehnen</button>
            `;
          }

          const statusBadge = istVersendet
            ? '<span class="anfrage-status-badge status-versendet">Versendet</span>'
            : '<span class="anfrage-status-badge status-offen">Offen</span>';

          optionsHTML += `
            <div class="anfrage-option">
              <div class="anfrage-option-header">
                <div class="anfrage-option-title">${esc(a.Produkte || '‚Äì')}</div>
                <div style="display:flex;gap:6px;align-items:center;">
                  ${statusBadge}
                  <span class="anfrage-option-label">${optionLabel}</span>
                </div>
              </div>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="dl">Monatspreis</span>
                  <span class="dv mono">${formatEuro(a.Preis_monat_EUR)}</span>
                </div>
                <div class="detail-item">
                  <span class="dl">Kaution</span>
                  <span class="dv mono">${formatEuro(a.Kaution)}</span>
                </div>
                <div class="detail-item">
                  <span class="dl">Gesamt (6 Mo + Kaution)</span>
                  <span class="dv mono">${formatEuro(a.Gesamtpreis_mit_Kaution)}</span>
                </div>
                <div class="detail-item">
                  <span class="dl">Mindestlaufzeit</span>
                  <span class="dv">${a.Laufzeit_Monate || 6} Monate</span>
                </div>
              </div>
              <div class="anfrage-actions">
                ${buttonsHTML}
              </div>
            </div>
          `;
        });

        // === Absage-Grund (einmal pro Gruppe, unten) ===
        const allIds = angeboteInGroup.map(a => a.id);
        const safeKundeNameAll = kundeName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        let footerHTML = '';
        if (isMulti) {
          footerHTML = `
            <div class="anfrage-actions-group">
              <div class="anfrage-grund-wrapper">
                <div class="anfrage-grund-label">Absage-Grund (optional, f√ºr alle Optionen)</div>
                <input type="text" class="anfrage-grund-input" id="grund-group-${allIds[0]}" placeholder="z.B. kein Set verf√ºgbar, zu weit entfernt...">
              </div>
              <button class="btn-ablehnen" onclick="angebotAlleAblehnen([${allIds.join(',')}], '${safeKundeNameAll}', 'grund-group-${allIds[0]}')">‚úó Alle ablehnen</button>
            </div>
          `;
        } else {
          footerHTML = `
            <div class="anfrage-actions-group">
              <div class="anfrage-grund-wrapper">
                <div class="anfrage-grund-label">Absage-Grund (optional)</div>
                <input type="text" class="anfrage-grund-input" id="grund-${allIds[0]}" placeholder="z.B. kein Set verf√ºgbar, zu weit entfernt...">
              </div>
            </div>
          `;
        }

        group.innerHTML = headerHTML + anliegenHTML + optionsHTML + footerHTML;
        listEl.appendChild(group);
      });

    } catch (err) {
      listEl.innerHTML = `<div class="loading" style="color: var(--red);">Fehler: ${err.message}</div>`;
    }
  }

  // ===== ANGEBOT ANGENOMMEN (Webhook: angebot-angenommen) =====
  async function angebotAngenommen(angebotId, kundeName) {
    if (!confirm(`Angebot f√ºr "${kundeName}" als ANGENOMMEN markieren?\n\nDas legt automatisch eine Miete an und pr√ºft die Instrumentenverf√ºgbarkeit.`)) return;

    const btnAngenommen = document.getElementById(`btn-angenommen-${angebotId}`);
    const btnAblehnen = document.getElementById(`btn-ablehnen-${angebotId}`);
    if (btnAngenommen) { btnAngenommen.disabled = true; btnAngenommen.textContent = '‚è≥ Wird verarbeitet...'; }
    if (btnAblehnen) btnAblehnen.disabled = true;

    try {
      const res = await fetch(`${N8N_BASE_URL}/angebot-angenommen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ angebot_id: angebotId })
      });

      if (!res.ok) throw new Error(`Webhook Fehler: ${res.status}`);

      const data = await res.json();

      if (data.instrumentVerfuegbar) {
        showToast(`‚úì Miete f√ºr ${kundeName} angelegt! Instrument aus Lager zugewiesen.`, 'success');
      } else {
        showToast(`‚ö† Miete f√ºr ${kundeName} angelegt ‚Äì kein Instrument lagernd, muss bestellt werden.`, 'warning');
      }

      setTimeout(() => { loadAnfragen(); loadMieten(); }, 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
      if (btnAngenommen) { btnAngenommen.disabled = false; btnAngenommen.textContent = '‚úì Angebot angenommen'; }
      if (btnAblehnen) btnAblehnen.disabled = false;
    }
  }

  // ===== ANGEBOT SENDEN (Webhook: angebot-erstellen) =====
  async function angebotSenden(angebotId, kundeName) {
    if (!confirm(`Angebot f√ºr "${kundeName}" erstellen und an info@ senden?`)) return;

    const btnSenden = document.getElementById(`btn-senden-${angebotId}`);
    const btnAblehnen = document.getElementById(`btn-ablehnen-${angebotId}`);
    btnSenden.disabled = true;
    btnAblehnen.disabled = true;
    btnSenden.textContent = '‚è≥ Wird erstellt...';

    try {
      const res = await fetch(`${N8N_BASE_URL}/angebot-erstellen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ angebot_id: angebotId })
      });

      if (!res.ok) throw new Error(`Webhook Fehler: ${res.status}`);

      const data = await res.json();
      showToast(`‚úì Angebot f√ºr ${kundeName} erstellt! (${data.angebotsnummer || ''})`, 'success');
      setTimeout(() => loadAnfragen(), 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
      btnSenden.disabled = false;
      btnAblehnen.disabled = false;
      btnSenden.textContent = '‚úì Angebot senden';
    }
  }

  // ===== ANGEBOT ABLEHNEN (Webhook: absage-senden) =====
  async function angebotAblehnen(angebotId, kundeName) {
    // Suche Grund-Input: erst pro-Option, dann Gruppen-Grund
    let grundInput = document.getElementById(`grund-${angebotId}`);
    if (!grundInput) grundInput = document.getElementById(`grund-group-${angebotId}`);
    const grund = grundInput ? grundInput.value.trim() : '';

    if (!confirm(`Anfrage von "${kundeName}" wirklich ablehnen?`)) return;

    const btnSenden = document.getElementById(`btn-senden-${angebotId}`);
    const btnAblehnen = document.getElementById(`btn-ablehnen-${angebotId}`);
    btnSenden.disabled = true;
    btnAblehnen.disabled = true;
    btnAblehnen.textContent = '‚è≥ Wird abgelehnt...';

    try {
      const res = await fetch(`${N8N_BASE_URL}/absage-senden`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ angebot_id: angebotId, grund })
      });

      if (!res.ok) throw new Error(`Webhook Fehler: ${res.status}`);

      showToast(`‚úó Anfrage von ${kundeName} abgelehnt. Absage-Email gesendet.`, 'success');
      setTimeout(() => loadAnfragen(), 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
      btnSenden.disabled = false;
      btnAblehnen.disabled = false;
      btnAblehnen.textContent = '‚úó Ablehnen';
    }
  }

  // ===== ALLE ANGEBOTE EINER GRUPPE ABLEHNEN =====
  async function angebotAlleAblehnen(ids, kundeName, grundInputId) {
    const grundInput = document.getElementById(grundInputId);
    const grund = grundInput ? grundInput.value.trim() : '';

    if (!confirm(`Alle ${ids.length} Angebots-Optionen von "${kundeName}" wirklich ablehnen?`)) return;

    // Disable all buttons in this group
    ids.forEach(id => {
      const s = document.getElementById(`btn-senden-${id}`);
      const a = document.getElementById(`btn-ablehnen-${id}`);
      if (s) s.disabled = true;
      if (a) a.disabled = true;
    });

    try {
      // Alle parallel ablehnen
      await Promise.all(ids.map(id =>
        fetch(`${N8N_BASE_URL}/absage-senden`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ angebot_id: id, grund })
        })
      ));

      showToast(`‚úó Alle ${ids.length} Optionen von ${kundeName} abgelehnt.`, 'success');
      setTimeout(() => loadAnfragen(), 1500);

    } catch (err) {
      showToast(`‚úó Fehler: ${err.message}`, 'error');
      ids.forEach(id => {
        const s = document.getElementById(`btn-senden-${id}`);
        const a = document.getElementById(`btn-ablehnen-${id}`);
        if (s) s.disabled = false;
        if (a) a.disabled = false;
      });
    }
  }
</script>

</body>
</html>
